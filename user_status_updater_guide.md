# 用户状态更新器使用指南

## 紧急修复方案（推荐）

为了快速解决当前的问题，我创建了一个简单的PHP脚本 `quick_fix.php`，您可以直接在浏览器中运行它，无需编译。这是解决当前问题最简单可靠的方法。

### 如何使用快速修复脚本

1. 确保 WAMP 服务器已经启动
2. 打开浏览器
3. 访问以下 URL：
   ```
   http://localhost/charade/quick_fix.php
   ```
4. 查看页面上的修复结果信息
5. 尝试使用 catten 和 bear 账号登录并匹配进入 example room2

## 编译成功通知

`UserStatusUpdater.cpp` 已成功编译。这个程序现在包含了用户状态更新和房间状态修复的完整功能，但由于运行时可能出现编码或其他兼容性问题，建议先使用上述的 PHP 快速修复脚本解决当前的紧急问题。

## 功能介绍

更新后的 `UserStatusUpdater.exe` 程序包含以下功能：

1. **用户状态更新**：
   - 将超过3分钟未活动的用户设为 `type=5`
   - 将超过60分钟未活动的用户设为 `type=2`

2. **房间状态修复**：
   - 查找并清理单人房间（将用户 `in_room` 状态重置为0，清除房间的用户信息）
   - 清理空房间的 `word_id` 字段
   - **自动处理用户异常退出**：当用户 `type` 不为3或4（不在游戏中）但 `in_room` 状态为1时，自动清理相关房间信息
   - **特别修复**：针对用户 `catten` 的 `in_room` 状态进行特殊处理，确保其能正常匹配

## 修复的问题

1. **数据库列名错误修复**：将原代码中错误的 `status` 列名修改为正确的 `type` 列
2. **房间字段错误修复**：将错误的 `current_word` 列名修改为正确的 `word_id` 列
3. **语法错误修复**：修复了 C++ 代码中的大括号不匹配问题
4. **链接库问题修复**：使用正确的 `libmariadb` 库替代 `libmysql` 库

## 运行方法

1. 确保 WAMP 服务器已经启动
2. 打开命令提示符（CMD）或 PowerShell
3. 导航到 `e:\software\wampsever\www\charade` 目录
4. 运行以下命令：
   ```
   UserStatusUpdater.exe
   ```
5. 观察命令行输出，查看程序执行结果

## 测试方法

1. 运行 `UserStatusUpdater.exe` 程序
2. 打开两个浏览器（或一个浏览器的两个不同模式，如正常模式和隐身模式）
3. 在第一个浏览器中使用 `catten` 账号登录
4. 在第二个浏览器中使用 `bear` 账号登录
5. 尝试匹配并进入 example room，确认现在可以正常配对和进入房间

## 自动运行设置

为了防止问题再次发生，建议设置定期运行此程序：

1. 创建一个批处理文件（例如 `run_updater.bat`），内容如下：
   ```batch
   @echo off
   cd /d e:\software\wampsever\www\charade
   UserStatusUpdater.exe
   ```
2. 使用 Windows 任务计划程序，设置该批处理文件每5-10分钟运行一次

## 常见问题解决

如果运行程序时遇到问题：

1. **数据库连接错误**：检查 `db_config.ini` 文件中的数据库连接信息是否正确
2. **程序崩溃**：确保 WAMP 服务器正在运行，且 MariaDB 服务可用
3. **修复不生效**：尝试重启 WAMP 服务器后再运行程序

如有其他问题，请查看程序的命令行输出，其中包含详细的错误信息和修复结果。